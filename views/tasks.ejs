<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tâches</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <nav>
    <a href="/">Accueil</a> |
    <a href="/tasks">Tâches</a> |
    <a href="/about">About</a> |
    <a href="/contact">Contact</a>
  </nav>
  <h1>Tâches</h1>
  <h2>Total des tâches : <span id="taskCount"><%= tasks.length %></span></h2>

  <!-- ajouter une nouvelle tâche -->
  <form id="addTaskForm">
    <input type="text" id="newTaskTitle" placeholder="Nouvelle tâche" required>
    <button type="submit">Ajouter</button>
  </form>

  <!-- Liste des tâches -->
  <ul id="taskList">
    <% tasks.forEach(task => { %>
      <li data-id="<%= task.id %>">
        <span class="<%= task.done ? 'done' : 'pending' %>"><%= task.title %></span> -
        <% if (task.done) { %>
          ✅ Terminée
        <% } else { %>
          ⏳ En cours
          <button class="doneBtn">Terminer</button>
        <% } %>
        <button class="deleteBtn">Supprimer</button>
      </li>
    <% }) %>
  </ul>

  <a href="/">Retour à l'accueil</a>

  <script>
    const addForm = document.getElementById('addTaskForm');
    const taskList = document.getElementById('taskList');
    const taskCount = document.getElementById('taskCount');

    // --- Ajouter une tâche ---
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('newTaskTitle').value.trim();
      if (!title) return;

      const res = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      });

      if (!res.ok) {
        const data = await res.json();
        alert(data.error);
        return;
      }

      const newTask = await res.json();

      const li = document.createElement('li');
      li.setAttribute('data-id', newTask.id);
      li.innerHTML = `
        <span class="pending">${newTask.title}</span> - ⏳ En cours
        <button class="doneBtn">Terminer</button>
        <button class="deleteBtn">Supprimer</button>
      `;
      taskList.appendChild(li);
      taskCount.textContent = taskList.children.length;

      addForm.reset();
    });

    // supprimer ou terminer une tache
    taskList.addEventListener('click', async (e) => {
      const li = e.target.closest('li');
      const taskId = li.dataset.id;

      // supprimer
      if (e.target.classList.contains('deleteBtn')) {
        const res = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
        if (res.ok) {
          li.remove();
          taskCount.textContent = taskList.children.length;
        } else {
          alert('Erreur lors de la suppression de la tâche.');
        }
      }

      // Marquer comme terminee
      if (e.target.classList.contains('doneBtn')) {
        const res = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ done: true })
        });
        if (res.ok) {
          li.querySelector('span').className = 'done';
          li.querySelector('span').textContent = li.querySelector('span').textContent;
          e.target.remove(); // Supprime le bouton "Terminer"
          li.innerHTML += ' ✅ Terminée';
        } else {
          alert('Erreur lors de la mise à jour de la tâche.');
        }
      }
    });
  </script>
</body>
</html>
